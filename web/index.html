<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DoctorAI · Guided Chat</title>
  <link rel="icon" type="image/png" href="/assets/doctorai-mini.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1b2a;
      --panel: #111c30;
      --card: #0f1726;
      --glass: rgba(255, 255, 255, 0.04);
      --ink: #e9f0ff;
      --muted: #9fb2d5;
      --accent: #4dd4ac;
      --accent-2: #62a5ff;
      --danger: #ef8891;
      --border: rgba(255, 255, 255, 0.08);
      --radius: 16px;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 12% 14%, rgba(77,212,172,0.10), transparent 32%),
        radial-gradient(circle at 86% 12%, rgba(98,165,255,0.14), transparent 30%),
        linear-gradient(145deg, #0a1220, #0e1a2d 40%, #0a1220);
      color: var(--ink);
      min-height: 100vh;
      padding: 28px 20px 40px;
      line-height: 1.6;
    }
    .page {
      max-width: 1280px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 0.9fr 1.1fr;
      gap: 18px;
      align-items: start;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.32);
      margin-bottom: 14px;
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .brand img { display: block; }
    .brand-logo { height: 30px; width: auto; }
    .brand-mini { height: 38px; width: 38px; border-radius: 12px; border: 1px solid var(--border); background: #0c1422; padding: 6px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.01em;
      border: 1px solid var(--border);
    }
    .hero {
      background: var(--card);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 18px;
      box-shadow: 0 22px 40px rgba(0,0,0,0.34);
      position: sticky;
      top: 16px;
    }
    h1 { font-family: 'Space Grotesk', sans-serif; margin: 8px 0 4px; letter-spacing: -0.01em; }
    h2 { margin: 0 0 10px; font-family: 'Space Grotesk', sans-serif; }
    p { margin: 0; color: var(--muted); }
    .hero-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .note-card {
      background: linear-gradient(140deg, rgba(77,212,172,0.08), rgba(98,165,255,0.08));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
    }
    .asset-strip {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .asset-strip img {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.28);
    }
    .asset-hero { width: 100%; border-radius: 14px; }
    .asset-small { height: 60px; width: auto; padding: 6px; }
    .chat-shell {
      background: var(--panel);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 18px;
      box-shadow: 0 22px 46px rgba(0,0,0,0.34);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 80vh;
    }
    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .agent-toggle {
      display: inline-flex;
      align-items: center;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    .agent-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .agent-btn.active {
      background: linear-gradient(135deg, rgba(77,212,172,0.16), rgba(98,165,255,0.16));
      color: var(--ink);
    }
    .status {
      color: var(--muted);
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      display: inline-block;
    }
    .chat-log {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 14px;
      max-width: 96%;
      line-height: 1.5;
      border: 1px solid var(--border);
      box-shadow: 0 14px 30px rgba(0,0,0,0.24);
    }
    .bubble.user {
      margin-left: auto;
      background: linear-gradient(135deg, rgba(98,165,255,0.18), rgba(77,212,172,0.22));
      color: #0a1220;
      font-weight: 600;
    }
    .bubble.ai {
      background: rgba(255,255,255,0.03);
      color: var(--ink);
    }
    .meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }
    .followups {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--ink);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.2s ease;
    }
    .chip:hover { transform: translateY(-1px); background: rgba(255,255,255,0.08); }
    .chip.outline { color: var(--muted); }
    .composer {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    textarea {
      width: 100%;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--ink);
      padding: 12px;
      font-size: 15px;
      resize: vertical;
      min-height: 120px;
    }
    textarea:focus { outline: 2px solid rgba(98,165,255,0.35); }
    .composer-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .file-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
    }
    .file-pill img { height: 34px; width: 34px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); display: none; }
    button.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      border: none;
      color: #0b1322;
      font-weight: 800;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      min-width: 150px;
      transition: transform 0.12s ease, box-shadow 0.22s ease, opacity 0.2s ease;
      box-shadow: 0 14px 28px rgba(77,212,172,0.25);
      font-family: 'Space Grotesk', sans-serif;
    }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .suggestions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .summary {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .summary h3 { margin: 0 0 6px; }
    .summary .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }
    .panel {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    ul { padding-left: 18px; margin: 6px 0; color: var(--muted); }
    .badge-warn { color: var(--danger); font-weight: 700; }
    .badge-soft { color: var(--accent); font-weight: 700; }
    footer { margin-top: 20px; color: var(--muted); font-size: 13px; text-align: center; }
    @media (max-width: 1080px) { .page { grid-template-columns: 1fr; } .hero { position: static; } }
    @media (max-width: 640px) {
      body { padding: 18px 12px 32px; }
      .composer-actions { flex-direction: column; align-items: stretch; }
      button.primary { width: 100%; }
      .chat-log { max-height: 420px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <section class="hero">
      <div class="topbar">
        <div class="brand">
          <img class="brand-logo" src="/assets/doctorai-logo.png" alt="DoctorAI" loading="lazy" />
          <span class="pill">Structured JSON · Verified</span>
        </div>
        <img class="brand-mini" src="/assets/doctorai-mini.png" alt="DoctorAI mini" loading="lazy" />
      </div>
      <h1>Guided GPT-style triage</h1>
      <p>Share your note or photo. DoctorAI asks follow-up questions first, then offers a cautious plan only after you answer.</p>
      <div class="hero-grid">
        <div class="note-card">
          <strong>Safety rails</strong>
          <p>Dermatology + therapist experts, OpenEvolve verification, red-flag triage, and “plan locked until follow-ups answered.”</p>
        </div>
        <div class="note-card">
          <strong>Session flavor</strong>
          <p>Minimal chat chrome, soft gradients, and quick-reply bubbles to keep you focused on answering the right questions.</p>
        </div>
      </div>
      <div class="asset-strip" aria-label="DoctorAI assets">
        <img class="asset-hero" src="/assets/doctorai-hero.png" alt="DoctorAI hero screen" loading="lazy" />
        <img class="asset-small" src="/assets/doctorai-mini.png" alt="DoctorAI mini icon" loading="lazy" />
        <img class="asset-small" src="/assets/doctorai-logo.png" alt="DoctorAI wordmark" loading="lazy" />
      </div>
    </section>

    <section class="chat-shell">
      <div class="chat-header">
        <div class="agent-toggle" id="agentToggle">
          <button class="agent-btn active" data-agent="dermatologist">Dermatologist</button>
          <button class="agent-btn" data-agent="therapist">Therapist</button>
        </div>
        <div class="status" id="status" aria-live="polite">Ready · plan waits for your follow-ups</div>
      </div>

      <div class="chat-log" id="chatLog" aria-live="polite">
        <div class="bubble ai">
          <strong>DoctorAI</strong> · I’ll keep things calm and safe. Share a short note and any image; I’ll ask 3–5 targeted follow-up questions before giving advice. Plan stays locked until you answer.
        </div>
      </div>

      <div class="suggestions" id="suggestions">
        <div class="chip outline" data-fill="No fever or chills.">No fever</div>
        <div class="chip outline" data-fill="Not immunosuppressed.">Not immunosuppressed</div>
        <div class="chip outline" data-fill="Started 3 days ago.">Started 3 days ago</div>
        <div class="chip outline" data-fill="Pain is mild (2/10).">Pain is mild</div>
      </div>

      <div class="composer">
        <textarea id="question" placeholder="Type your note or answer a follow-up… (Cmd/Ctrl + Enter to send)"></textarea>
        <div class="composer-actions">
          <label class="file-pill" for="image">
            <span>Attach image (optional)</span>
            <img id="preview" alt="Preview" />
          </label>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="primary" id="submitBtn">Send to DoctorAI</button>
          </div>
        </div>
        <input id="image" type="file" accept="image/*" style="display:none;" />
      </div>

      <section class="summary" id="resultBody">
        <h3>Latest reasoning</h3>
        <p>No analysis yet. Send a message to start.</p>
      </section>
      <footer>DoctorAI is a triage demo. It cannot diagnose or prescribe; always follow up with a licensed clinician.</footer>
    </section>
  </div>

  <script>
    const agentToggle = document.getElementById('agentToggle');
    const questionInput = document.getElementById('question');
    const imageInput = document.getElementById('image');
    const preview = document.getElementById('preview');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const chatLog = document.getElementById('chatLog');
    const suggestions = document.getElementById('suggestions');
    const resultBody = document.getElementById('resultBody');

    let selectedAgent = 'dermatologist';
    let chatHistory = [];
    let currentFollowupKey = '';
    let answeredFollowupKey = '';

    function escapeHTML(str) {
      return (str || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function addMessage(role, html) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${role}`;
      bubble.innerHTML = html;
      chatLog.appendChild(bubble);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setSuggestions(list) {
      suggestions.innerHTML = '';
      const base = [
        'No fever or chills.',
        'Not immunosuppressed.',
        'Pain is mild (2/10).',
        'Started a few days ago.',
      ];
      const merged = [...new Set([...(list || []), ...base])].filter(Boolean).slice(0, 10);
      merged.forEach((item) => {
        const chip = document.createElement('div');
        chip.className = 'chip outline';
        chip.dataset.fill = item;
        chip.textContent = item;
        chip.addEventListener('click', () => {
          questionInput.value = item;
          questionInput.focus();
        });
        suggestions.appendChild(chip);
      });
    }

    agentToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('.agent-btn');
      if (!btn) return;
      agentToggle.querySelectorAll('.agent-btn').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      selectedAgent = btn.dataset.agent;
    });

    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if (!file) { preview.style.display = 'none'; return; }
      const reader = new FileReader();
      reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(file);
    });

    function serializeAssistant(v, planText) {
      const followups = Array.isArray(v.followups) ? v.followups.join(' | ') : '';
      return [
        `Answer: ${v.answer || ''}`,
        `Provisional: ${v.provisional_diagnosis || 'unclear'}`,
        `Plan: ${planText || ''}`,
        `Triage: ${v.triage || ''}`,
        followups ? `Follow-ups: ${followups}` : '',
      ].filter(Boolean).join('\n');
    }

    function updateResultCard(v, planText, planLocked, agentLabel) {
      const followups = (v.followups || []).map((q) => `<li>${escapeHTML(q)}</li>`).join('');
      const diffs = (v.differentials || []).map((d) => `<li>${escapeHTML(d)}</li>`).join('');
      const risk = escapeHTML(v.risk_flags || '');
      const provisional = escapeHTML(v.provisional_diagnosis || 'unclear');
      const answer = escapeHTML(v.answer || '—');
      const triage = escapeHTML(v.triage || '—');
      const confidence = escapeHTML(v.confidence ?? '—');

      resultBody.innerHTML = `
        <h3>Latest reasoning · ${agentLabel}</h3>
        <div class="panel">
          <strong>Answer</strong><br/>
          <div style="color: var(--ink); margin-top:4px;">${answer}</div>
        </div>
        <div class="grid" style="margin-top:10px;">
          <div class="panel">
            <strong>Provisional</strong>
            <div style="margin-top:4px;">${provisional}</div>
            <div style="margin-top:6px;"><strong>Alternatives</strong><ul>${diffs || '<li>None</li>'}</ul></div>
            <div class="badge-soft" style="margin-top:4px;">Confidence: ${confidence}</div>
          </div>
          <div class="panel">
            <strong>Plan</strong>
            <div style="margin-top:4px;">${planLocked ? 'Plan locked until you answer follow-up questions.' : escapeHTML(planText || '—')}</div>
            <div style="margin-top:6px;"><strong>Triage</strong><br/>${triage}</div>
            <div style="margin-top:6px;" class="badge-warn">${risk}</div>
          </div>
        </div>
        <div class="panel" style="margin-top:10px;">
          <strong>Follow-up questions</strong>
          <ul>${followups || '<li>None</li>'}</ul>
        </div>
      `;
    }

    async function analyze() {
      const question = questionInput.value.trim();
      if (!question) { statusEl.textContent = 'Add a short description first.'; return; }

      addMessage('user', escapeHTML(question));
      chatHistory.push({ role: 'user', content: question });
      if (currentFollowupKey) {
        answeredFollowupKey = currentFollowupKey;
      }

      submitBtn.disabled = true;
      statusEl.textContent = 'Analyzing…';

      const form = new FormData();
      form.append('question', question);
      form.append('agent', selectedAgent);
      if (chatHistory.length > 1) {
        form.append('history', JSON.stringify(chatHistory.slice(0, -1)));
      }
      if (imageInput.files[0]) form.append('image', imageInput.files[0]);

      try {
        const res = await fetch('/analyze', { method: 'POST', body: form });
        const data = await res.json();
        renderAssistant(data);
        statusEl.textContent = 'Done';
        questionInput.value = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Failed to analyze';
        addMessage('ai', '<strong>DoctorAI</strong> · Sorry, something went wrong getting your response.');
      } finally {
        submitBtn.disabled = false;
      }
    }

    function renderAssistant(payload) {
      if (!payload || !payload.verification) {
        addMessage('ai', '<strong>DoctorAI</strong> · No response from the agent.');
        return;
      }
      const v = payload.verification;
      const followups = Array.isArray(v.followups) ? v.followups.filter(Boolean) : [];
      const followupKey = followups.length ? JSON.stringify(followups) : '';
      const planLocked = !!(followupKey && followupKey !== answeredFollowupKey);
      const planText = v.plan || '';

      const followupHtml = followups.length
        ? `<div class="followups">${followups.map((q) => `<div class="chip" data-fill="${escapeHTML(q)}">${escapeHTML(q)}</div>`).join('')}</div>`
        : '';

      const planLine = planLocked
        ? '<div class="pill">Plan locked — answer follow-ups to unlock.</div>'
        : `<div><strong>Plan</strong>: ${escapeHTML(planText || '—')}</div>`;

      const messageHtml = `
        <strong>DoctorAI</strong><br/>
        ${escapeHTML(v.answer || '')}
        <div class="meta">
          <span>Provisional: ${escapeHTML(v.provisional_diagnosis || 'unclear')}</span>
          <span>Triage: ${escapeHTML(v.triage || '—')}</span>
          <span>Confidence: ${escapeHTML(v.confidence ?? '—')}</span>
        </div>
        ${planLine}
        ${followups.length ? '<div style="margin-top:6px;"><strong>Follow-ups to answer:</strong></div>' : ''}
        ${followupHtml}
      `;
      addMessage('ai', messageHtml);

      const agentLabel = escapeHTML(payload.agent || selectedAgent);
      updateResultCard(v, planText, planLocked, agentLabel);
      setSuggestions(followups);

      currentFollowupKey = followupKey;
      if (!followupKey) {
        answeredFollowupKey = '';
      }

      chatHistory.push({ role: 'assistant', content: serializeAssistant(v, planLocked ? 'Plan locked' : planText) });
    }

    submitBtn.addEventListener('click', analyze);
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) analyze();
    });
    suggestions.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip || !chip.dataset.fill) return;
      questionInput.value = chip.dataset.fill;
      questionInput.focus();
    });
    chatLog.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip || !chip.dataset.fill) return;
      questionInput.value = chip.dataset.fill;
      questionInput.focus();
    });
  </script>
</body>
</html>
